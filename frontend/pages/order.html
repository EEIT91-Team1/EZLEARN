<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <link rel="icon" href="../imgs/favicon.ico" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <title>訂單確認</title>
  </head>
  <body class="bg-gray-50">
    <div id="navbar"></div>

    <main class="container mx-auto px-4 py-8">
      <div class="max-w-4xl mx-auto">
        <div class="flex flex-col lg:flex-row gap-8">
          <div class="lg:w-2/3">
            <div
              class="bg-white rounded-lg shadow-md p-6 mb-6"
            >
              <h2 class="text-2xl font-bold mb-4">
                購買明細
                <span class="text-gray-500 text-base"
                  >總共 n 件</span
                >
              </h2>

              <div class="border rounded-lg p-4 mb-4">
                <div class="flex items-center">
                  <span
                    class="bg-gray-200 px-3 py-1 rounded mr-4"
                    >課程</span
                  >
                  <h3 class="text-lg flex-grow">
                    課程名稱
                  </h3>
                  <span class="text-xl">NT$ 9999 元</span>
                </div>
              </div>
            </div>

            <div
              class="bg-white rounded-lg shadow-md p-6 mb-6"
            >
              <h2 class="text-2xl font-bold mb-4">
                <i class="bi bi-credit-card mr-2"></i>
                信用卡/簽帳金融卡付款
                <button
                  class="float-right text-gray-500 text-base"
                >
                  刪除
                </button>
              </h2>

              <div class="bg-gray-50 p-6 rounded-lg">
                <div class="mb-4">
                  <label class="block text-gray-700 mb-2"
                    >信用卡卡號</label
                  >
                  <input
                    type="text"
                    class="w-full p-2 border rounded"
                    placeholder="**** **** **** ****"
                    maxlength="19"
                    oninput="this.value = this.value.replace(/[^\d]/g, '').replace(/(\d{4})/g, '$1 ').trim()"
                  />
                  <span class="text-red-500 text-sm hidden"
                    >請輸入16位數字</span
                  >
                </div>

                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-gray-700 mb-2">
                      信用卡有效期限
                      <span
                        class="text-red-500 text-sm hidden"
                        >請輸入有效月份(01-12)及年份</span
                      >
                    </label>
                    <input
                      type="text"
                      class="w-full p-2 border rounded"
                      placeholder="MM/YY"
                      maxlength="5"
                      oninput="let val = this.value.replace(/\D/g,'');
                              if (val.length > 2) {
                                this.value = val.substr(0,2) + '/' + val.substr(2);
                              } else {
                                this.value = val;
                              }
                              if(val.length >= 2) {
                                let month = parseInt(val.substr(0,2));
                                if(month > 12 || month < 1) {
                                  this.parentElement.querySelector('span').classList.remove('hidden');
                                } else {
                                  this.parentElement.querySelector('span').classList.add('hidden');
                                }
                              }"
                    />
                  </div>
                  <div>
                    <label class="block text-gray-700 mb-2">
                      安全識別碼
                      <span
                        class="text-red-500 text-sm hidden"
                        >請輸入3位數字</span
                      >
                    </label>
                    <input
                      type="text"
                      class="w-full p-2 border rounded"
                      placeholder="CVV/CVC"
                      maxlength="3"
                      oninput="this.value = this.value.replace(/\D/g,'');
                              if(this.value.length != 3) {
                                this.previousElementSibling.querySelector('span').classList.remove('hidden');
                              } else {
                                this.previousElementSibling.querySelector('span').classList.add('hidden');
                              }"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="lg:w-1/3">
            <div class="bg-white rounded-lg shadow-md p-6">
              <h2 class="text-xl font-bold mb-4">
                訂單明細
              </h2>
              <div class="border-b pb-4 mb-4">
                <div class="flex justify-between mb-2">
                  <span
                    ><span id="itemCount">0</span>
                    件商品</span
                  >
                </div>
                <div
                  class="flex justify-between text-gray-600"
                >
                  <span>價格統計</span>
                  <span
                    >NT$
                    <span id="totalPrice">0</span> 元</span
                  >
                </div>
              </div>
              <div
                class="flex justify-between text-2xl font-bold mb-6"
              >
                <span
                  >總計：NT$
                  <span id="finalTotal">0</span> 元</span
                >
              </div>
              <button
                class="w-full bg-black text-white py-3 rounded-lg hover:bg-gray-800 transition"
                onclick="submitOrder()"
              >
                送出
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <div id="footer"></div>
    <script src="../js/header-footer.js"></script>
    <script>
      function calculateOrder() {
        const items = document.querySelectorAll(
          ".border.rounded-lg.p-4.mb-4"
        );
        const itemCount = items.length;

        let total = 0;
        items.forEach((item) => {
          const priceText = item.querySelector(
            "span:last-child"
          ).textContent;
          const price = parseInt(
            priceText.replace(/[^0-9]/g, "")
          );
          total += price;
        });

        document.getElementById("itemCount").textContent =
          itemCount;
        document.getElementById("totalPrice").textContent =
          total.toLocaleString();
        document.getElementById("finalTotal").textContent =
          total.toLocaleString();
      }

      document.addEventListener(
        "DOMContentLoaded",
        calculateOrder
      );

      document.addEventListener(
        "DOMContentLoaded",
        function () {
          const cartItems = JSON.parse(
            localStorage.getItem("cartItems") || "[]"
          );
          const cartTotal =
            localStorage.getItem("cartTotal");

          const itemsContainer = document.querySelector(
            ".bg-white .mb-4"
          );
          itemsContainer.innerHTML = "";

          cartItems.forEach((item) => {
            const itemHtml = `
            <div class="border rounded-lg p-4 mb-4">
              <div class="flex items-center">
                <span class="bg-gray-200 px-3 py-1 rounded mr-4">課程</span>
                <h3 class="text-lg flex-grow">${
                  item.title
                }</h3>
                <span class="text-xl">NT$ ${item.price.toLocaleString()} 元</span>
              </div>
            </div>
          `;
            itemsContainer.innerHTML += itemHtml;
          });

          document.getElementById("itemCount").textContent =
            cartItems.length;
          document.getElementById(
            "totalPrice"
          ).textContent = cartTotal.toLocaleString();
          document.getElementById(
            "finalTotal"
          ).textContent = cartTotal.toLocaleString();
        }
      );

      function submitOrder() {
        const cardNumber = document.querySelector(
          'input[placeholder="**** **** **** ****"]'
        ).value;
        const expiryDate = document.querySelector(
          'input[placeholder="MM/YY"]'
        ).value;
        const cvv = document.querySelector(
          'input[placeholder="CVV/CVC"]'
        ).value;

        if (!cardNumber || !expiryDate || !cvv) {
          alert("請輸入完整的信用卡資訊");
          return;
        }

        const success = Math.random() > 0.3;
        if (success) {
          const orderNumber =
            "ORD" + Date.now().toString().slice(-8);
          const amount = localStorage.getItem("cartTotal");
          window.location.href = `payment-result.html?status=success&orderNumber=${orderNumber}&amount=${amount}`;
        } else {
          window.location.href =
            "payment-result.html?status=failed&error=付款處理失敗，請確認您的付款資訊是否正確。";
        }
      }
    </script>
  </body>
</html>
